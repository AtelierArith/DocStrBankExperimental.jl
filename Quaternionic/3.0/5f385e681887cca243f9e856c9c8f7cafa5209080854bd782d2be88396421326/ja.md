```
align(a⃗, b⃗, [w])
```

[ワハバの問題](https://en.wikipedia.org/wiki/Wahba%27s_problem)を解決し、最初の点のセットと回転された2番目のセットとの距離を最小化することによって、点のセット`a⃗`を対応する点のセット`b⃗`に整列させる回転を見つけます。

ここで、`a⃗`と`b⃗`は等しいサイズの`QuatVec`の配列でなければなりません。もし存在する場合、`w`は等しいサイズの実数の配列でなければなりません。存在しない場合は1と見なされます。損失関数を次のように定義します。

$$
L(ℛ) ≔ Σᵢ wᵢ ‖a⃗ᵢ - ℛ b⃗ᵢ‖²
$$

ここで、$ℛ$は回転演算子であり、この関数を最小化する最適な$ℛ$に対応するクォータニオンを返します。

点が回転を一意に決定しない可能性があることに注意してください — 1つまたは両方の点のセットが回転対称である場合などです。その場合、損失関数$L(ℛ)$は依然として最小化され、出力されたクォータニオンによって点は最適に整列されますが、そのクォータニオンは一意ではありません。

# ノート

彼らの著書[*宇宙船姿勢決定と制御の基礎* (2014)](https://doi.org/10.1007/978-1-4939-0802-8)の中で、マークリーとクラッシディスは「ダベンポートの方法はワハバの問題を解決するための最良の方法である」と述べています。この方法は、特定の行列の主固有ベクトル（最大の固有値を持つもの）として最適なクォータニオンを提供します。補助行列を次のように定義します。

$$
S ≔ Σᵢ wᵢ a⃗ᵢ b⃗ᵢᵀ
$$

およびベクトル

$$
s⃗ ≔ \begin{bmatrix}
S₂₃-S₃₂ \\
S₃₁-S₁₃ \\
S₁₂-S₂₁
\end{bmatrix}.
$$

次に、重要な行列は

$$
M ≔ \begin{bmatrix}
S + Sᵀ - (\mathrm{tr}S)\, I₃ & s⃗ \\
s⃗ᵀ & \mathrm{tr}S
\end{bmatrix}
$$

この行列は、上記のように点が回転を一意に決定しない場合に対応する退化した固有値を持つ可能性があります。
