```
orbital_evolution(pnsystem; kwargs...)
orbital_evolution(M₁, M₂, χ⃗₁, χ⃗₂, Ωᵢ; kwargs...)
```

非偏心コンパクトバイナリの進行する軌道力学を統合します。

## 必要な引数

この関数の最初の引数は、これらの必要な引数（およびキーワード引数の中の `Rᵢ`、`Λ₁`、`Λ₂`）をエンコードする単一の `PNSystem` であるか、以下の引数が明示的に与えられる必要があります：

  * `M₁`: オブジェクト1の初期質量
  * `M₂`: オブジェクト2の初期質量
  * `χ⃗₁`: オブジェクト1の初期無次元スピン、`S⃗₁/M₁²`
  * `χ⃗₂`: オブジェクト2の初期無次元スピン、`S⃗₂/M₂²`
  * `Ωᵢ`: 初期軌道角周波数

（明示的な入力には `Ωᵢ` が必要ですが、`PNSystem` には `vᵢ` が入力として必要です。）

これらのパラメータはすべて「初期」条件を説明します。 ここでの「初期」と「最初」の異なる意味については、以下を参照してください。 質量は潮汐加熱の結果として時間とともに変化しますが、進行中のほとんどの間は変化は非常に小さいです。 スピンは歳差運動により方向が変わりますが、潮汐加熱により大きさも変化します。 したがって、ここで渡される値は、周波数 `Ωᵢ` に対応する初期データの瞬間に正確に与えられたものだけです。

## キーワード引数

これらのキーワードのいくつかはUnicodeで与えられていますが、ASCII文字列としても与えることができます。 たとえば、`Λ₁` は `Lambda1` として同等に入力できます。 デフォルト値は同じで、どちらでも構いません。

  * `Λ₁=0` または `Lambda1`: オブジェクト1の潮汐結合パラメータ。
  * `Λ₂=0` または `Lambda2`: オブジェクト2の潮汐結合パラメータ。
  * `Ω₁=Ωᵢ` または `Omega_1`: 出力データの最初の角周波数。 これは `Ωᵢ` よりも小さい場合があり、その場合はこの点まで逆に統合し、逆方向と前方の解を1つのシームレスな出力に結合します。（次のセクションを参照。）
  * `Ωₑ=Ω(v=1,M=M₁+M₂)` または `Omega_e`: ODE統合を停止する最終角周波数。 システムがこの周波数に達する前に統合が停止する場合があります。これは、PNが回復不能に崩壊したことを検出した場合です。たとえば、質量の1つがもはや厳密に正でない場合、スピンが超極端である場合、またはPN速度パラメータ `v` が減少している場合、または `(0,1)` の範囲にない場合です。 通常、`v < 0.35` の場合にのみ警告が発行されますが、`quiet=true` の場合は情報メッセージが発行されます。
  * `Rᵢ=Rotor(1)` または `R_i`: バイナリの初期方向。
  * `approximant="TaylorT1"`: 進化方程式の右辺を評価する方法。 他の可能性は [`"TaylorT4"`](@ref TaylorT4!) と [`"TaylorT5"`](@ref TaylorT5!) です。 詳細については [`TaylorT1!`](@ref) のドキュメントを参照してください。
  * `PNOrder=typemax(Int)`: PN展開において $v^2$ の累乗を保持する順序。 デフォルトは、各PN表現において利用可能なすべての項を含めることです。
  * `check_up_down_instability=true`: 「上下不安定性」（以下を参照）がこのシステムに影響を与える可能性がある場合に警告します。
  * `time_stepper=Vern9()`: ODEを統合するためのOrdinaryDiffEqのソルバーの選択。
  * `abstol=eps(T)^(11//16)`: ODEソルバーの絶対許容誤差で、`T` はすべての位置引数が昇格される共通の型です。 これは局所的な誤差推定に対する許容誤差であり、必ずしもグローバルな誤差ではありません。 `11//16` は、`Float64` 計算に対しておおよそ11桁の精度（局所的）を持つことを示唆するために選ばれたものです。他の浮動小数点型に対しても、その型のイプシロンに対して類似の精度を持ちます。
  * `reltol=eps(T)^(11//16)`: ODEソルバーの相対許容誤差。（上記と同様。）
  * `termination_criteria_forwards=nothing`: 時間の前方進化に使用するコールバック。 デフォルト値の議論については以下を参照してください。
  * `termination_criteria_backwards=nothing`: 時間の逆進化に使用するコールバック。 デフォルト値の議論については以下を参照してください。
  * `force_dtmin=true`: `dt` が統合者自身の最小値を下回る場合、これが偽であれば、統合者は終了基準が優雅に退出する機会を持つ前に即座にエラーを発生させます。 ここでの真の値は、`dtmin_terminator` コールバックが何らかの効果を持つために重要です。
  * `quiet=true`: `false` に設定すると、ODE統合の成功した終了に関する情報メッセージ（目標 $v$ がいずれかの方向に達したときに発生します）が提供されます。 他の理由で終了する場合でも警告は発行されます。 それらもサイレンスしたい場合は、次のようにします。

    ```julia
    using Logging
    with_logger(SimpleLogger(Logging.Error)) do
        <your code goes here>
    end
    ```
  * `saves_per_orbit=0`: 0より大きい場合、出力は補間され、各軌道に対して `saves_per_orbit` の時間ステップが出力に含まれます。 これは、以下に記載されている `saveat` オプションと矛盾します。

残りのすべてのキーワード引数は、[`solve` 関数](https://github.com/SciML/DiffEqBase.jl/blob/8e6173029c630f6908252f3fc28a69c1f0eab456/src/solve.jl#L393) に渡されます。 詳細については、その関数のドキュメントを参照してください。 重要なものとしては、次のものがあります。

  * `saveat`: 解を保存する特定の時間を示します。解決フェーズ中の時間ステップまたは特定の時間のベクトルです。

特に、均一な時間ステップ `δt` で解を出力したい場合は、`saveat=δt` のように渡す必要があります。 `solve` キーワード `dt` は、適応システムの初期提案に過ぎないため、渡すべきではありません。 このオプションを *および* `saves_per_orbit` オプションを渡すことは許可されていません。

また、`callback` を使用することができ、上記の `termination_criteria_*` 引数によって生成されたコールバックと組み合わされます。 つまり、引数を `callback` に渡すことで、デフォルトのもの *と* 自分自身のものを使用できます。 詳細については [ドキュメント](https://diffeq.sciml.ai/dev/features/callback_functions/) を参照してください。ただし、自分のコールバックを作成したい場合は、プロジェクトに `OrdinaryDiffEq` を追加する必要があります。あるいは、いくつかのより洗練された組み込みコールバックのために `DifferentialEquations` を追加する必要があるかもしれません。

## ODEシステム

進化した変数は、順番に次のとおりです。

  * `M₁`: ブラックホール1の質量
  * `M₂`: ブラックホール2の質量
  * `χ⃗₁ˣ`: ブラックホール1の無次元スピンの $x$ 成分
  * `χ⃗₁ʸ`: $y$ 成分...
  * `χ⃗₁ᶻ`: $z$ 成分...
  * `χ⃗₂ˣ`: ブラックホール2の無次元スピンの $x$ 成分
  * `χ⃗₂ʸ`: $y$ 成分...
  * `χ⃗₂ᶻ`: $z$ 成分...
  * `Rʷ`: フレームローターのスカラー成分
  * `Rˣ`: $x$ 成分...
  * `Rʸ`: $y$ 成分...
  * `Rᶻ`: $z$ 成分...
  * `v`: 総質量 $M$ と軌道角周波数 $Ω$ に関連するPN「速度」パラメータ $v = (M Ω)^{1/3}$
  * `Φ`: $Ω$ を統合することによって与えられる軌道位相

質量とスピンの大きさは [`tidal_heating`](@ref) に従って進化します。 スピンの方向は [`Ω⃗ᵪ₁`](@ref) と [`Ω⃗ᵪ₂`](@ref) に従って進化します。 フレームは角速度 [`Ω⃗ₚ`](@ref) で歳差運動し、[ニュートン的軌道角速度の方向](@ref ℓ̂) の周りで角周波数 `Ω` で回転します。 フレームローター $R$ は、[Boyle (2016)](https://arxiv.org/abs/1604.08139) に記載されているように、これらの角速度の合計を統合することによって与えられます。 最後に、PNパラメータ $v$ は次のように進化します。

$$
\dot{v} = - \frac{\mathcal{F} + \dot{M}_1 + \dot{M}_2} {\mathcal{E}'}
$$

ここで [`𝓕`](@ref) はシステムからの重力波エネルギーのフラックス、$\dot{M}_1$ と $\dot{M}_2$ は [`tidal_heating`](@ref) によって計算された潮汐結合によるもので、[`𝓔′`](@ref) は $v$ に関する結合エネルギーの導関数です。 `"TaylorT1"` の場合、この方程式の右辺は与えられたように評価されます。 `"TaylorT4"` の場合、右辺は最初に $v$ のテイラー級数として展開され、次に所望の順序で切り捨てられます。 `"TaylorT5"` の場合、右辺の *逆* は $v$ のテイラー級数として展開され、所望の順序で切り捨てられ、$v$ に関する表現を得るために逆転されます。

## 返される解

返される量は、データを抽出および補間するためのさまざまな機能を持つ [`ODESolution`](https://diffeq.sciml.ai/dev/basics/solution/) オブジェクトです。 このオブジェクトを `sol` と呼びます。

!!! note
    解は、ODE統合者がステップした時間点でのデータを伴います。 ただし、密な出力も *伴います*（`orbital_evolution` を呼び出すときに手動でオフにしない限り）。 これは、任意の他の時間点のセットに解を補間できることを意味します。単に `sol(t)` と呼び出すことで、時間点のベクトル `t` に対して解を補間できます。 それによって返される量は、元の解と同様に、以下に記載されているすべての機能を持ちます。 もしデータの一部だけを取得したい場合は、オプションのキーワード引数 `idxs` を提供して、以下に説明されている要素のどれを補間したいかを指定できます。 たとえば、`M₁` と `M₂` の値だけを補間したい場合は、`sol(t, idxs=[1,2])` を使用できます。


フィールド `sol.t` は、解が与えられる時間点のセットです。 時間ステップ `j` での `i` 番目の変数にアクセスするには、`sol[i, j]` を使用します。[^\1] コロンを使用することもできます。 たとえば、`sol[:, j]` は時間ステップ `j` でのすべてのデータのベクトルであり、`sol[i, :]` はすべての時間での `i` 番目の変数のベクトルです。

[^1]: ここで、`i` 番目の変数は、ODEシステムの進化した変数のリストにおける番号を指します。

便利なことに、シンボルを使って個々の変数にアクセスすることもできます。 たとえば、`sol[:v]` は各時間ステップでのPN速度パラメータのベクトルを返します。 `:v` のコロンに注意してください。これは [Juliaの `Symbol` の表記法](https://docs.julialang.org/en/v1/base/base/#Core.Symbol) です。

## 初期周波数と最初の周波数と終了周波数の違い

`Ωᵢ`（下付き文字 `i`）と `Ω₁`（下付き文字 `1`）の違いに注意してください。 最初の `Ωᵢ` は、ODE統合者が開始する *初期条件* の角周波数を表します。 2番目の `Ω₁` は、出力データの最初の要素の目標角周波数を表します。 つまり、ODE統合は `Ωᵢ` から合併まで前方に時間を進め、その後 — `Ωᵢ>Ω₁` の場合 — `Ωᵢ` に戻り、`Ω₁` まで逆に時間を進めます。 出力データは、これら2つをつなぎ合わせて1つの連続した（前方に時間を進める）データ系列にします。

たとえば、数値相対性理論（NR）シミュレーションに合わせようとしている場合、システムが角周波数 `Ωᵢ` で軌道を回っているときにNRデータから質量とスピンを読み取ることができます。 この点から時間を前方に進めてポストニュートン（PN）解を統合することで、PNとNRの波形を比較できます。 ただし、NRデータに存在するよりも *早い* 時間で波形が何であったかを知りたい場合もあります。 そのためには、時間を逆に統合する必要があります。 逆に統合するポイントを `Ω₁` でパラメータ化します。 いずれの場合でも、出力解の要素 `1` は周波数 `Ω₁` を持ちます — ただし、デフォルトでは `Ωᵢ` と等しいです。

同様に、オプション引数 `Ωₑ=1` は解の `end` 要素の周波数です — これはJuliaの最後の要素に対する表記法です。 これは、総質量が1を超える場合にPNパラメータ $v$ が1を超えないように自動的に減少します。

## 上下不安定性

[上下不安定性](http://arxiv.org/abs/1506.09116)（より質量の大きいブラックホールが軌道角速度と整列したスピンを持ち、質量の小さい方が反整列したスピンを持つ場合）は、初期時にほぼゼロの歳差運動を持つシステムが、早いまたは遅い時間に高度に歳差運動するシステムに進化する原因となる可能性があることに注意してください。 これは、数値的な問題ではなく、実際の物理的結果です。 真に非歳差運動のシステムをシミュレートしたい場合は、スピンのインプレース成分を正確に0に設定する必要があります。 デフォルトでは、この条件をチェックし、初期の歳差運動が低いシステムに対して遭遇する可能性がある場合は警告を発行します。 不安定領域を計算するために使用される関数は [`up_down_instability`](@ref) です。

## 時間ステッパーアルゴリズム

`Tsit5()` は、`Float64` を使用する場合の中低許容誤差のデフォルトの良い選択です。 硬さが結果に影響を与えているように見える場合は、`AutoTsit5(Rosenbrock23())` が硬さが発生したときに自動的に切り替わります。 特に `Double64` を使用する場合は、より厳しい許容誤差のために `Vern9()` または `AutoVern9(Rodas5P())` が良い選択です。 非常に緩い許容誤差の場合、`Float32` を使用する場合は、`OwrenZen3()` を使用する方が良いかもしれません。

## 終了基準

終了基準は、統合の効率と解の正確性にとって重要です。 前方および後方の時間進化に対するデフォルト値は、それぞれ次のとおりです。

```julia
CallbackSet(
    termination_forwards(v(Ω=Ωₑ, M=M₁+M₂)),
    dtmin_terminator(T),
    decreasing_v_terminator(),
    nonfinite_terminator()
)
```

および

```julia
CallbackSet(
    termination_backwards(v(Ω=Ω₁, M=M₁+M₂)),
    dtmin_terminator(T),
    nonfinite_terminator()
)
```

ここで `T` は入力引数の共通浮動小数点型です。 追加の終了基準が必要な場合は、`CallbackSet` の追加要素として追加できます。 詳細については [コールバックのドキュメント](https://diffeq.sciml.ai/stable/features/callback_functions/) を参照してください。
